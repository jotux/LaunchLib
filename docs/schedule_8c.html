<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>LaunchLib: schedule.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">LaunchLib</div>
   <div id="projectbrief">An easy-to-use library to help kickstart your launchpad development.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('schedule_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">schedule.c File Reference</div>  </div>
</div>
<div class="contents">

<p>Generic scheduling mechanisms.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="global_8h_source.html">global.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="schedule_8h_source.html">schedule.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="hardware_8h_source.html">hardware.h</a>&quot;</code><br/>
</div>
<p><a href="schedule_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#a7cca52889a75eb770ca7a70cbf47a858">ScheduleTimerInit</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the schedule timer used to check callouts and callbacks.  <a href="#a7cca52889a75eb770ca7a70cbf47a858"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#ab12586e59cf64577040be8ed06e4814a">CallbackRegister</a> (<a class="el" href="schedule_8h.html#a52acb0158eef8a6a72957b6605c95353">CallbackFn</a> func, <a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a> run_time)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a callback to the store for periodic execution.  <a href="#ab12586e59cf64577040be8ed06e4814a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#a036325aad3e8e1a9194ae25867db6f22">CallbackService</a> (<a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a> current_time)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Check the callback list for functions that are ready to run.  <a href="#a036325aad3e8e1a9194ae25867db6f22"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#a0767ccd3af067fb315ab6d4c08dedf04">CallbackMode</a> (<a class="el" href="schedule_8h.html#a52acb0158eef8a6a72957b6605c95353">CallbackFn</a> func, enum <a class="el" href="global_8h.html#aace9e950edab699a0fa0e281503ee4da">IoMode</a> mode)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Enable or disable a function callback.  <a href="#a0767ccd3af067fb315ab6d4c08dedf04"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="global_8h.html#aef44329758059c91c76d334e8fc09700">int8_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#ac7515403c92ea393f971b6688aa5b87b">CalloutRegister</a> (<a class="el" href="schedule_8h.html#a1c02760ad032ffd6ebc2b0a01d474f0d">CalloutFn</a> func, <a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a> run_time)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a callout to the store for one-time execution.  <a href="#ac7515403c92ea393f971b6688aa5b87b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#ab55f47631849be4bd604d9aec2ffb390">CalloutCancel</a> (<a class="el" href="schedule_8h.html#a1c02760ad032ffd6ebc2b0a01d474f0d">CalloutFn</a> func)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Disable a function callout before it has run.  <a href="#ab55f47631849be4bd604d9aec2ffb390"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#aff0bd22b0eece12f7fc20a6516712f66">get_callout_map_size</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the number of occupied slots in the callout map (pending callouts)  <a href="#aff0bd22b0eece12f7fc20a6516712f66"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#a69a9c59f9d987a53d8b418c851373bb9">CalloutService</a> (<a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a> current_time)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Check the callout list for functions that are ready to run.  <a href="#a69a9c59f9d987a53d8b418c851373bb9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">__interrupt void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#a31e7ad787760dc23b9e359185f5eb69b">ScheduleTimerOverflow</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Interrupt routine run by overflow of watchdog timer.  <a href="#a31e7ad787760dc23b9e359185f5eb69b"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">volatile <a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="schedule_8c.html#a7446a6cae82b017d6e65871b3c805eb1">now</a> = 0</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">global time accessible by everyone  <a href="#a7446a6cae82b017d6e65871b3c805eb1"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Generic scheduling mechanisms. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Joe Brown </dd></dl>

<p>Definition in file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="a0767ccd3af067fb315ab6d4c08dedf04"></a><!-- doxytag: member="schedule.c::CallbackMode" ref="a0767ccd3af067fb315ab6d4c08dedf04" args="(CallbackFn func, enum IoMode mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CallbackMode </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="schedule_8h.html#a52acb0158eef8a6a72957b6605c95353">CallbackFn</a>&#160;</td>
          <td class="paramname"><em>func</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="global_8h.html#aace9e950edab699a0fa0e281503ee4da">IoMode</a>&#160;</td>
          <td class="paramname"><em>mode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Enable or disable a function callback. </p>
<p>Search the callback store for the specified function and enable or disable it based on the mode passed in. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">func</td><td>callback function to configure </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mode</td><td>enabled or disabled </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00060">60</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 0;
    <span class="keywordflow">for</span> (i = 0;i &lt; event_count;i++)
    {
        <span class="keywordflow">if</span> (func == callback_store[i].func)
        {
            callback_store[i].<a class="code" href="struct_callback_event.html#a81a7031abfd335275a5acf475d7ef766">enabled</a> = mode;
            <span class="keywordflow">if</span> (mode)
            {
                callback_store[i].<a class="code" href="struct_callback_event.html#a1b21ad88610b96246ed05e4b7a645817">next_run_time</a> = <a class="code" href="schedule_8c.html#a7446a6cae82b017d6e65871b3c805eb1" title="global time accessible by everyone">now</a> +
                                                  callback_store[i].<a class="code" href="struct_callback_event.html#a787c60dfca79b1561e9cbd020561e5e4">run_time</a>;
            }
            <span class="keywordflow">break</span>;
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab12586e59cf64577040be8ed06e4814a"></a><!-- doxytag: member="schedule.c::CallbackRegister" ref="ab12586e59cf64577040be8ed06e4814a" args="(CallbackFn func, uint32_t run_time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CallbackRegister </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="schedule_8h.html#a52acb0158eef8a6a72957b6605c95353">CallbackFn</a>&#160;</td>
          <td class="paramname"><em>func</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a>&#160;</td>
          <td class="paramname"><em>run_time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add a callback to the store for periodic execution. </p>
<p>Take the function and run time and store them in the callback store. Intially set the enabled flag to false to keep us from accidentally calling a function before it is expected. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">func</td><td>function pointer registered to callback </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">run_time</td><td>period on which to run the callback function </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00032">32</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (event_count &lt; <span class="keyword">sizeof</span>(callback_store)/<span class="keyword">sizeof</span>(<a class="code" href="schedule_8h.html#a52acb0158eef8a6a72957b6605c95353" title="function pointer to a callback">CallbackFn</a>))
    {
        <span class="comment">// Callbacks are initialized disabled</span>
        callback_store[event_count].<a class="code" href="struct_callback_event.html#a81a7031abfd335275a5acf475d7ef766">enabled</a>       = <a class="code" href="global_8h.html#a06fc87d81c62e9abb8790b6e5713c55baa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
        callback_store[event_count].<a class="code" href="struct_callback_event.html#a5ee86bf0b23d84d0d119ee6dac811695">func</a>          = func;
        callback_store[event_count].<a class="code" href="struct_callback_event.html#a787c60dfca79b1561e9cbd020561e5e4">run_time</a>      = run_time - 1;
        callback_store[event_count].<a class="code" href="struct_callback_event.html#a1b21ad88610b96246ed05e4b7a645817">next_run_time</a> = <a class="code" href="schedule_8c.html#a7446a6cae82b017d6e65871b3c805eb1" title="global time accessible by everyone">now</a> + run_time;
        event_count++;
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a036325aad3e8e1a9194ae25867db6f22"></a><!-- doxytag: member="schedule.c::CallbackService" ref="a036325aad3e8e1a9194ae25867db6f22" args="(uint32_t current_time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CallbackService </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a>&#160;</td>
          <td class="paramname"><em>current_time</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check the callback list for functions that are ready to run. </p>
<p>Search the callback store for functions that enabled with a time that is equal to the current global time. If we find the function call it and reset the run_time based on the stored value. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">current_time</td><td>current global time from now variable </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00045">45</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 0;
    <span class="keywordflow">for</span> (i = 0;i &lt; event_count;i++)
    {
        <span class="keywordflow">if</span> (callback_store[i].enabled == <a class="code" href="global_8h.html#a06fc87d81c62e9abb8790b6e5713c55baa82764c3079aea4e60c80e45befbb839">TRUE</a> &amp;&amp;
            current_time == callback_store[i].next_run_time)
        {
            callback_store[i].<a class="code" href="struct_callback_event.html#a1b21ad88610b96246ed05e4b7a645817">next_run_time</a> = current_time +
                                              callback_store[i].<a class="code" href="struct_callback_event.html#a787c60dfca79b1561e9cbd020561e5e4">run_time</a>;
            callback_store[i].<a class="code" href="struct_callback_event.html#a5ee86bf0b23d84d0d119ee6dac811695">func</a>();
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab55f47631849be4bd604d9aec2ffb390"></a><!-- doxytag: member="schedule.c::CalloutCancel" ref="ab55f47631849be4bd604d9aec2ffb390" args="(CalloutFn func)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CalloutCancel </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="schedule_8h.html#a1c02760ad032ffd6ebc2b0a01d474f0d">CalloutFn</a>&#160;</td>
          <td class="paramname"><em>func</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Disable a function callout before it has run. </p>
<p>Search the callout store for the specific function. If we find it go clear the map to indicate the slot is vacant. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">func</td><td>function pointer to search for and cancel </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00104">104</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 0;
    <span class="keywordflow">for</span> (i = 0;i &lt; <a class="code" href="hardware_8h.html#a633e51fd220983033afe28f559b9243f">MAX_CALLOUT_CNT</a>;i++)
    {
        <span class="comment">// find the slot</span>
        <span class="keywordflow">if</span> (callout_store[i].func == func)
        {
            <span class="comment">// clear</span>
            callout_map &amp;= ~<a class="code" href="global_8h.html#a11643f271076024c395a93800b3d9546">_BV</a>(i);
            <span class="keywordflow">break</span>;
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac7515403c92ea393f971b6688aa5b87b"></a><!-- doxytag: member="schedule.c::CalloutRegister" ref="ac7515403c92ea393f971b6688aa5b87b" args="(CalloutFn func, uint32_t run_time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="global_8h.html#aef44329758059c91c76d334e8fc09700">int8_t</a> CalloutRegister </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="schedule_8h.html#a1c02760ad032ffd6ebc2b0a01d474f0d">CalloutFn</a>&#160;</td>
          <td class="paramname"><em>func</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a>&#160;</td>
          <td class="paramname"><em>run_time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add a callout to the store for one-time execution. </p>
<p>Take the function and run time and store them in the callout store. For callouts we maintain a "map" of callouts in a bit array. When we store a new function we find an empty slot (0 in the bit array) and set it. That bit corresponds to the index of the callout store the function pointer is stored at. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">func</td><td>function pointer registered to callout slot </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">run_time</td><td>Specific time in which to run the function </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00078">78</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="global_8h.html#aef44329758059c91c76d334e8fc09700">int8_t</a> ret = -1;
    <span class="comment">// event queue full?</span>
    <span class="keywordflow">if</span> (<a class="code" href="schedule_8c.html#aff0bd22b0eece12f7fc20a6516712f66" title="Return the number of occupied slots in the callout map (pending callouts)">get_callout_map_size</a>() != <a class="code" href="hardware_8h.html#a633e51fd220983033afe28f559b9243f">MAX_CALLOUT_CNT</a>)
    {
        <a class="code" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 0;
        <span class="keywordflow">for</span> (i = 0;i &lt; <a class="code" href="hardware_8h.html#a633e51fd220983033afe28f559b9243f">MAX_CALLOUT_CNT</a>;i++)
        {
            <span class="comment">// find the first open slot</span>
            <span class="keywordflow">if</span> (!(callout_map &amp; <a class="code" href="global_8h.html#a11643f271076024c395a93800b3d9546">_BV</a>(i)))
            {
                <span class="comment">// claim the slot</span>
                callout_map |= <a class="code" href="global_8h.html#a11643f271076024c395a93800b3d9546">_BV</a>(i);
                <span class="comment">// save our data</span>
                callout_store[i].<a class="code" href="struct_callout_event.html#a0e689c61e79a9b51ed4dfcd11c390bb1">func</a> = func;
                callout_store[i].<a class="code" href="struct_callout_event.html#a040c82f3961da0defdbb57979c68283d">run_time</a> = <a class="code" href="schedule_8c.html#a7446a6cae82b017d6e65871b3c805eb1" title="global time accessible by everyone">now</a> + run_time;
                <span class="comment">// return success</span>
                ret = 0;
                <span class="keywordflow">break</span>;
            }
        }
    }
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a69a9c59f9d987a53d8b418c851373bb9"></a><!-- doxytag: member="schedule.c::CalloutService" ref="a69a9c59f9d987a53d8b418c851373bb9" args="(uint32_t current_time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CalloutService </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a>&#160;</td>
          <td class="paramname"><em>current_time</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check the callout list for functions that are ready to run. </p>
<p>Search the callout store for functions that enabled with a time that is equal to the current global time. If we find the function call it and vacate the slot in the map. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">current_time</td><td>current global time from now variable </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00130">130</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 0;
    <span class="keywordflow">for</span> (i = 0;i &lt; <a class="code" href="hardware_8h.html#a633e51fd220983033afe28f559b9243f">MAX_CALLOUT_CNT</a>;i++)
    {
        <span class="comment">// find occupied slots and see if the function there is ready</span>
        <span class="keywordflow">if</span> ((callout_map &amp; <a class="code" href="global_8h.html#a11643f271076024c395a93800b3d9546">_BV</a>(i)) &amp;&amp; current_time == callout_store[i].run_time)
        {
            <span class="comment">// run the function</span>
            callout_store[i].<a class="code" href="struct_callout_event.html#a0e689c61e79a9b51ed4dfcd11c390bb1">func</a>();
            <span class="comment">// vacate the slot</span>
            callout_map &amp;= ~<a class="code" href="global_8h.html#a11643f271076024c395a93800b3d9546">_BV</a>(i);
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="aff0bd22b0eece12f7fc20a6516712f66"></a><!-- doxytag: member="schedule.c::get_callout_map_size" ref="aff0bd22b0eece12f7fc20a6516712f66" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> get_callout_map_size </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Return the number of occupied slots in the callout map (pending callouts) </p>
<p>Use K&amp;R method to run through the callout map and count the number of bits. This represents the number of slot occupied in the callout store. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the number of functions pending in the callout map </dd></dl>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00119">119</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> sum = 0;
    <a class="code" href="global_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> map = callout_map;
    <span class="keywordflow">for</span> (sum = 0; map; sum++)
    {
        map &amp;= map - 1;
    }
    <span class="keywordflow">return</span> sum;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7cca52889a75eb770ca7a70cbf47a858"></a><!-- doxytag: member="schedule.c::ScheduleTimerInit" ref="a7cca52889a75eb770ca7a70cbf47a858" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ScheduleTimerInit </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize the schedule timer used to check callouts and callbacks. </p>
<p>Configure the watchdog timer to periodically wake up and execute. We currently use a 2ms period and the timing in <a class="el" href="hardware_8h.html" title="Definitions hardware config (ports, pins, and module settings)">hardware.h</a> for _millisecond, _second, and the like are based on this time. If the period configured in this function is changed the defintions in <a class="el" href="hardware_8h.html" title="Definitions hardware config (ports, pins, and module settings)">hardware.h</a> will also need to be changed. </p>

<p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>make this more robust and change depending on DCO freq </dd></dl>
</p>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00025">25</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    WDTCTL = WDT_MDLY_8;        <span class="comment">// interval = 500us @ 16Mhz</span>
    WDT_INT_ENABLE |= WDTIE;    <span class="comment">// Enable WDT interrupt</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a31e7ad787760dc23b9e359185f5eb69b"></a><!-- doxytag: member="schedule.c::ScheduleTimerOverflow" ref="a31e7ad787760dc23b9e359185f5eb69b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__interrupt void ScheduleTimerOverflow </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Interrupt routine run by overflow of watchdog timer. </p>
<p>When the interrupt fires increment the global time and service the call*s. </p>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00147">147</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="schedule_8c.html#a7446a6cae82b017d6e65871b3c805eb1" title="global time accessible by everyone">now</a>++;
    <a class="code" href="schedule_8c.html#a036325aad3e8e1a9194ae25867db6f22" title="Check the callback list for functions that are ready to run.">CallbackService</a>(<a class="code" href="schedule_8c.html#a7446a6cae82b017d6e65871b3c805eb1" title="global time accessible by everyone">now</a>);
    <a class="code" href="schedule_8c.html#a69a9c59f9d987a53d8b418c851373bb9" title="Check the callout list for functions that are ready to run.">CalloutService</a>(<a class="code" href="schedule_8c.html#a7446a6cae82b017d6e65871b3c805eb1" title="global time accessible by everyone">now</a>);
}
</pre></div>
</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a7446a6cae82b017d6e65871b3c805eb1"></a><!-- doxytag: member="schedule.c::now" ref="a7446a6cae82b017d6e65871b3c805eb1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="global_8h.html#a33594304e786b158f3fb30289278f5af">uint32_t</a> <a class="el" href="schedule_8h.html#a7446a6cae82b017d6e65871b3c805eb1">now</a> = 0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>global time accessible by everyone </p>

<p>Definition at line <a class="el" href="schedule_8c_source.html#l00011">11</a> of file <a class="el" href="schedule_8c_source.html">schedule.c</a>.</p>

</div>
</div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="schedule_8c.html">schedule.c</a>      </li>
      <li class="footer">Generated on Wed Mar 7 2012 23:19:46 for LaunchLib by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
